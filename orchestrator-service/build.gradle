group 'microservice-kubernetes-demo'
version '1.0-SNAPSHOT'

apply plugin: 'java'
apply plugin: 'org.springframework.boot'
apply plugin: 'docker'

sourceCompatibility = 1.8

repositories {
    mavenCentral()
    jcenter()
}

buildscript {
    repositories{
        jcenter()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:1.4.3.RELEASE")
        classpath("se.transmode.gradle:gradle-docker:1.2")
    }
}

jar{
    manifest.attributes("Main-Class": "com.ef.Application")
}

dependencies {
    compile("org.springframework.boot:spring-boot-starter-web:1.4.3.RELEASE")

    testCompile("junit:junit:4.12")
    testCompile('org.springframework.boot:spring-boot-starter-test:1.4.3.RELEASE')
}

task dockerize(type: Docker, dependsOn: build) {
    applicationName = "orchestrator-service"
    push = false
    dockerfile = file("Dockerfile")
    doFirst {
        copy {
            from jar
            into stageDir
        }
    }
}

task createDeploymentTest(type: Exec){
    commandLine 'kubectl', 'run', 'orchestrator-service', '--image', 'microservice-kubernetes-demo/orchestrator-service:1.0-SNAPSHOT', '--namespace', 'test', '--port', '8082'
}

task createDeploymentProduction(type: Exec){
    commandLine 'kubectl', 'run', 'orchestrator-service', '--image', 'microservice-kubernetes-demo/orchestrator-service:1.0-SNAPSHOT', '--namespace', 'production', '--port', '8082'
}

task createDeployment(dependsOn: [createDeploymentTest, createDeploymentProduction])

task createServiceTest(type: Exec){
    commandLine 'kubectl', 'expose', 'deployment', 'orchestrator-service', '--namespace', 'test', '--type', 'NodePort'
}

task createServiceProduction(type: Exec){
    commandLine 'kubectl', 'expose', 'deployment', 'orchestrator-service', '--namespace', 'production', '--type', 'NodePort'
}

task createService(dependsOn: [createServiceTest, createServiceProduction])

createService.mustRunAfter createDeployment

task deployToKubernetes(dependsOn: [createDeployment, createService])

task deleteDeploymentTest(type: Exec){
    commandLine 'kubectl', 'delete', 'deployment', 'orchestrator-service', '--namespace', 'test'
}

task deleteDeploymentProduction(type: Exec){
    commandLine 'kubectl', 'delete', 'deployment', 'orchestrator-service', '--namespace', 'production'
}

task deleteServiceTest(type: Exec){
    commandLine 'kubectl', 'delete', 'service', 'orchestrator-service', '--namespace', 'test'
}

task deleteServiceProduction(type: Exec){
    commandLine 'kubectl', 'delete', 'service', 'orchestrator-service', '--namespace', 'production'
}

task deleteService(dependsOn: [deleteServiceTest, deleteServiceProduction])

task deleteDeployment(dependsOn: [deleteDeploymentTest, deleteDeploymentProduction])

deleteDeployment.mustRunAfter deleteService

task undeployFromKubernetes(dependsOn: [deleteService, deleteDeployment])